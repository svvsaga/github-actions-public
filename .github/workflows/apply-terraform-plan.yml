name: Apply Terraform plan
on:
  workflow_call:
    inputs:
      ref:
        description: Which release to deploy, e.g. "datacatalog-web-v13"
        required: true
        type: string
      environment:
        description: Which environment to deploy to (e.g. STM, ATM or PROD).
        type: string
        required: true
      skip_diff:
        required: false
        type: string
        description: Set to 'true' to apply Terraform plan without checking if state has changed since plan was created.
      saga_app_root:
        description: Path to source code project from root of Git repo
        type: string
        required: true
      storage_bucket:
        description: GCP Storage bucket where Terraform plans are stored
        type: string
        required: true
      application_name:
        description: Name of application, e.g. Reisetid - Ingest
        type: string
        required: true
      application_id:
        description: Application ID, e.g. reisetid-ingest
        type: string
        required: true
      workload_identity_project_id:
        description: The project ID of the workload identity project to use with `gcloud`. Will be used to set workload identity provider to `projects/<workload_identity_project_id>/locations/global/workloadIdentityPools/default/providers/github`, and use the `terraform@<workload_identity_project_id>.iam.gserviceaccount.com` service account.
        type: string
        required: true
    secrets:
      github_app_private_key:
        description: Private key for GitHub application to get app token
        required: true
      github_app_id:
        description: GitHub application ID to get app token
        required: true

jobs:
  deploy:
    name: Deploy infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          ref: ${{ inputs.ref }}

      - name: Authenticate to Google Cloud with Terraform service account
        id: auth
        uses: google-github-actions/auth@v0
        with:
          workload_identity_provider: projects/${{ inputs.workload_identity_project_id }}/locations/global/workloadIdentityPools/default/providers/github
          service_account: terraform@${{ inputs.workload_identity_project_id }}.iam.gserviceaccount.com

      - name: Setup Google Cloud SDK with Workload Identity Federation
        uses: svvsaga/github-actions-public/setup-gcloud-with-workload-identity@v3.12.0
        with:
          workload_identity_project_id: ${{ inputs.workload_identity_project_id }}

      - name: Get app token
        id: get_token
        uses: tibdex/github-app-token@36464acb844fc53b9b8b2401da68844f6b05ebb0
        with:
          private_key: ${{ secrets.github_app_private_key }}
          app_id: ${{ secrets.github_app_id }}

      - name: Set GitHub token
        run: |
          git config --global url."https://x-access-token:${{ steps.get_token.outputs.token }}@github.com".insteadOf https://github.com
          echo "GITHUB_TOKEN=${{ steps.get_token.outputs.token }}" >> $GITHUB_ENV

      - name: Deploy plan for ${{ inputs.environment }}
        uses: svvsaga/github-actions-public/apply-terraform-plan-from-gcs@v3.10.0
        with:
          environment: ${{ inputs.environment }}
          project_root: ${{ inputs.saga_app_root }}
          storage_bucket: ${{ inputs.storage_bucket }}
          storage_prefix: ${{ inputs.application_id }}
          application: ${{ inputs.application_name }}
          github_token: ${{ github.token }}
          skip_diff: ${{ inputs.skip_diff }}
