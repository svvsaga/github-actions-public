name: Create Terraform plan
description: Create Terraform plan

inputs:
  terraform_dir:
    description: The working directory, e.g. where the Terraform files are located.
    required: true
  plan_bucket:
    description: The GCS bucket where the Terraform plan description will be stored.
    required: true
  plan_prefix:
    description: Folder / prefix to add to the plan description file name in GCS. E.g. "terraform-plans/my-app".
    required: true
  ref:
    description: Which commit, tag or branch to plan terraform from. Defaults to same as workflow is run from if empty.
    required: false
    default: ${{ github.sha }}
  service_account_key:
    description: Terraform Service Account private key to use with `gcloud`.
    required: true
  github_token:
    description: Token used when authenticating with GitHub. Defaults to `github.token`.
    required: false
    default: ${{ github.token }}
  plan_artifact_name:
    description: Name of the plan file to upload to GitHub artifacts. Defaults to "terraform.plan".
    required: false
    default: terraform.plan
  tf_backend_config:
    description: Terraform backend configuration to use. See https://www.terraform.io/docs/language/settings/backends/configuration.html#partial-configuration.
    required: false
    default: ""

runs:
  using: composite
  steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        ref: ${{ inputs.ref }}
  
    - name: Read TF and TG versions
      working-directory: .
      shell: bash
      run: |
        echo "TF_VERSION=$(cat .terraform-version | awk '{$1=$1};1')" >> $GITHUB_ENV
        echo "TG_VERSION=$(cat .terragrunt-version | awk '{$1=$1};1')" >> $GITHUB_ENV

    - name: Setup Google Cloud SDK with Terraform service account
      uses: google-github-actions/setup-gcloud@master
      with:
        version: latest
        service_account_key: ${{ inputs.service_account_key }}
        export_default_credentials: true

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        terraform_version: ${{ env.TF_VERSION }}
        terraform_wrapper: false

    - name: Setup Terragrunt
      uses: autero1/action-terragrunt@25ff9d20b92812c1870be23cce4b965c1ea59008
      with:
        terragrunt_version: ${{ env.TG_VERSION }}

    - name: Terragrunt init
      working-directory: ${{ inputs.terraform_dir }}
      shell: bash
      run: test -z "${{ inputs.tf_backend_config }}" && terragrunt init || terragrunt init -backend-config=${{ inputs.tf_backend_config }}

    - name: Create Terraform plan
      working-directory: ${{ inputs.terraform_dir }}
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github_token }}
      run: terragrunt plan -no-color -input=false -out="${{ inputs.plan_artifact_name }}"

    - name: Upload plan
      uses: actions/upload-artifact@v2
      with:
        name: ${{ inputs.plan_artifact_name }}
        path: ${{ inputs.terraform_dir }}/${{ inputs.plan_artifact_name }}
        retention-days: 1
        if-no-files-found: error

    - name: Set plan description filename env variable
      working-directory: ${{ inputs.terraform_dir }}
      shell: bash
      run: echo "PLAN_TXT_FILENAME=$(date -u +'%Y-%m-%dT%H%M%SZ')_${{ github.sha }}.plan.txt" >> $GITHUB_ENV

    - name: Render plan description
      working-directory: ${{ inputs.terraform_dir }}
      shell: bash
      run: terragrunt show -no-color ${{ inputs.plan_artifact_name }} > ${{ env.PLAN_TXT_FILENAME }}

    - name: Publish plan description
      id: publish-plan-description
      uses: google-github-actions/upload-cloud-storage@main
      with:
        path: ${{ inputs.terraform_dir }}/${{ env.PLAN_TXT_FILENAME }}
        destination: ${{ inputs.plan_bucket }}/${{ inputs.plan_prefix }}
        gzip: false

    - name: Set whether plan has changes
      id: set-has-changes
      working-directory: ${{ inputs.terraform_dir }}
      shell: bash
      run: grep -q "No changes. Your infrastructure matches the configuration." "${{ env.PLAN_TXT_FILENAME }}" && echo "::set-output name=has_changes::0" && echo "No changes found." || echo "::set-output name=has_changes::1" && echo "Changes found."

outputs:
  has_changes:
    description: Whether the plan has changes.
    value: ${{ toJSON(steps.set-has-changes.outputs.has_changes == 1) }}
  plan_description_url:
    description: Full URL of the plan description.
    value: ${{ steps.publish-plan-description.outputs.uploaded }}
